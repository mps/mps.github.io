---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('posts', ({ data }) => data.published !== false);
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = new Date(post.data.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof sortedPosts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="Blog">
  <div class="max-w-2xl mx-auto px-6 pb-12">
    <h1 class="font-display text-3xl md:text-4xl font-medium mb-12 animate-fade-in-up" style="animation-fill-mode: both;">Writing</h1>

    {years.map((year, yearIndex) => (
      <section
        class="mb-14 animate-fade-in-up"
        style={`animation-fill-mode: both; animation-delay: ${(yearIndex + 1) * 100}ms;`}
      >
        <h2 class="section-label flex items-center gap-3">
          <span>{year}</span>
          <span class="flex-1 h-px bg-gradient-to-r from-neutral-800 to-transparent dark:from-neutral-700"></span>
        </h2>
        <ul class="space-y-3">
          {postsByYear[Number(year)].map((post) => (
            <li class="accent-bar py-1">
              {post.data.link ? (
                <span class="flex items-baseline gap-2">
                  <a
                    href={post.data.link}
                    class="text-neutral-100 no-underline-effect hover:text-accent-400 transition-colors"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    {post.data.title}
                  </a>
                  <a
                    href={`/${post.slug}`}
                    class="text-neutral-600 no-underline-effect hover:text-accent-500 text-sm"
                    title="Permalink"
                  >
                    &#8599;
                  </a>
                </span>
              ) : (
                <a
                  href={`/${post.slug}`}
                  class="text-neutral-100 no-underline-effect hover:text-accent-400 transition-colors"
                >
                  {post.data.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </section>
    ))}
  </div>
</BaseLayout>
