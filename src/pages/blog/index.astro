---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('posts', ({ data }) => data.published !== false);
const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = new Date(post.data.date).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof sortedPosts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="Blog">
  <div class="max-w-2xl mx-auto px-6 pb-12">
    <h1 class="text-2xl md:text-3xl font-semibold mb-12">Writing</h1>

    {years.map((year) => (
      <section class="mb-12">
        <h2 class="text-sm uppercase tracking-wide text-neutral-500 dark:text-neutral-400 mb-4">
          {year}
        </h2>
        <ul class="space-y-3">
          {postsByYear[Number(year)].map((post) => (
            <li class="flex items-baseline gap-2">
              {post.data.link ? (
                <>
                  <a
                    href={post.data.link}
                    class="text-neutral-900 dark:text-neutral-100 no-underline hover:underline"
                    target="_blank"
                    rel="noopener noreferrer"
                  >
                    {post.data.title}
                  </a>
                  <a
                    href={`/${post.slug}`}
                    class="text-neutral-400 dark:text-neutral-500 no-underline hover:text-neutral-600 dark:hover:text-neutral-300"
                    title="Permalink"
                  >
                    â†—
                  </a>
                </>
              ) : (
                <a
                  href={`/${post.slug}`}
                  class="text-neutral-900 dark:text-neutral-100 no-underline hover:underline"
                >
                  {post.data.title}
                </a>
              )}
            </li>
          ))}
        </ul>
      </section>
    ))}
  </div>
</BaseLayout>
